name: CI & Lint

on:
  push:
    branches: [ main ]
  pull_request:

# This gives the "fix-formatting" job permission to commit changes
permissions:
  contents: write

jobs:
  # --- JOB 1: RUNS FIRST ---
  # This job will fix lint and format issues and commit them
  fix-formatting:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          # Need to fetch history for the auto-commit to work
          fetch-depth: 0 

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Ruff
        run: pip install ruff

      - name: Run Ruff Linter Fix
        run: ruff check . --fix

      - name: Run Ruff Formatter
        run: ruff format .

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-fix Ruff issues"

  # --- JOB 2: RUNS SECOND ---
  # This job will only start after 'fix-formatting' is complete
  run-tests:
    # This 'needs' keyword forces this job to WAIT for 'fix-formatting' to succeed.
    needs: fix-formatting
    
    runs-on: ubuntu-latest
    steps:
      # This checkout gets the *newest* code,
      # which includes the commit from the 'fix-formatting' job.
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Or your project's version
          cache: 'pip'

      # --- THIS IS THE FIX ---
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv pip install -r requirements.txt # This will work now

      - name: Run Pytest
        run: uv run pytest -q --maxfail=1 --disable-warnings
        
  # --- JOB 3: RUNS IN PARALLEL WITH TESTS ---
  codeql:
    # This also waits for the formatting to be fixed
    needs: fix-formatting
    runs-on: ubuntu-latest
    permissions:
      security-events: write # Required for CodeQL
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3