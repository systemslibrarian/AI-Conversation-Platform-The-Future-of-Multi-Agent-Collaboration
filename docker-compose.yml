services:
  conversation:
    build: .
    image: ai-conversation-platform:5.0
    env_file: .env
    environment:
      PROMETHEUS_PORT: "${PROMETHEUS_PORT:-8000}"
      DATA_DIR: "/data"
    volumes:
      - type: bind
        source: ./data
        target: /data
      - type: bind
        source: ./logs
        target: /app/logs
    command: >
      aic-start --agent1 ${AGENT1:-claude} --agent2 ${AGENT2:-chatgpt}
      --topic "${TOPIC:-AI governance}" --turns ${TURNS:-12} --yes

  ui:
    build: .
    image: ai-conversation-platform:5.0
    env_file: .env
    environment:
      PROMETHEUS_PORT: "${PROMETHEUS_PORT:-8000}"
      DATA_DIR: "/data"
    ports:
      - "${UI_PORT:-8501}:8501"
      - "${METRICS_PORT:-8000}:8000"
    volumes:
      - type: bind
        source: ./data
        target: /data
      - type: bind
        source: ./logs
        target: /app/logs
    command: streamlit run web/app.py --server.port 8501 --server.address 0.0.0.0
    depends_on:
      - conversation

  prometheus:
    image: prom/prometheus:v2.53.0
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    depends_on:
      - conversation
      - ui

  grafana:
    image: grafana/grafana:11.1.0
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD:?Set GF_ADMIN_PASSWORD in .env}
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
